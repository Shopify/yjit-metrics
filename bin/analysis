#!/usr/bin/env ruby

require "optparse"
require "yaml"

require_relative "../lib/yjit_metrics"

options = {}
args = OptionParser.new do |opts|
  opts.on("--regression", "Only show benchmarks that have regressed")
  opts.on("--spacious", "Include more spacing")
  opts.on("--notify", "Send slack notification with regression info")
end.parse!(into: options)

first = true
report = YJITMetrics::Analysis.report_from_dir(args[0])
report.results.each_pair do |m, h|
  h.each_pair do |p, vs|
    # Put blank line between sections.
    puts unless first
    first = false

    puts "#{m} #{p}"
    len = vs.keys.map(&:size).max
    vs.sort.each do |b, report|
      next if report[:streaks].size == 1
      next if options[:regression] && !report[:regression]

      puts if options[:spacious]

      report.each.with_index do |(k,v), i|
        prefix = i.zero? ? b : ""
        printf " %*s %s: %s\n", len, prefix, k, v
      end
    end
  end
end

if options[:notify]
  report.regression_notification&.then do |msg|
    YJITMetrics::Notifier.new(title: "Regressions", body: msg).notify!
  end
end
