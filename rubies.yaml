---
runtime_options:
  no_jit: &no_jit
    - --disable-yjit # --disable-zjit
  yjit: &yjit
    - --yjit
  yjit_stats: &yjit_stats
    # Use "quiet" mode since ruby-bench will record the runtime stats in the json file anyway.
    # Having the text stats print out makes it harder to report stderr on failures.
    - --yjit
    - --yjit-stats=quiet
  zjit: &zjit
    - --zjit
  zjit_stats: &zjit_stats
    # Use "quiet" mode since yjit-bench will record the runtime stats in the json file anyway.
    # Having the text stats print out makes it harder to report stderr on failures.
    - --zjit-stats=quiet

builds:
  _base: &build_base
    install: repo
    git_url: "https://github.com/ruby/ruby"
    git_branch: master
    override_name: cruby

  ruby-metrics-app-debug:
    <<: *build_base
    env:
      CPPFLAGS: "-DRUBY_DEBUG=1"
    configure_args:
      - --enable-yjit=dev
      - --enable-zjit=dev

  ruby-metrics-app-jit-stats:
    <<: *build_base
    configure_args:
      - --enable-yjit=stats
      - --enable-zjit=stats

  ruby-metrics-app-jit-prod: &build_jit
    <<: *build_base
    configure_args:
      - --enable-yjit
      - --enable-zjit

  ruby-metrics-app-prev:
    <<: *build_jit
    # In order to build "prev" ruby the same way we build "prod" ruby
    # we build it from source, so we use a tag that represents a recent release.
    git_branch: "v3_4_7"
    override_name: prev
    configure_args:
      # Ruby 3.3 only supports yjit.
      - --enable-yjit

  truffleruby-dev:
    install: ruby-build

runtime_configs:
  debug_ruby_no_jit:
    build: ruby-metrics-app-debug
    opts: *no_jit

  yjit_stats:
    build: ruby-metrics-app-jit-stats
    opts: *yjit_stats

  zjit_stats:
    build: ruby-metrics-app-jit-stats
    opts: *zjit_stats

  prod_ruby_no_jit:
    build: &prod_jit ruby-metrics-app-jit-prod
    opts: *no_jit

  prod_ruby_with_yjit:
    build: *prod_jit
    opts: *yjit

  prod_ruby_zjit:
    build: *prod_jit
    opts: *zjit

  prev_ruby_no_jit:
    build: &prev_ruby ruby-metrics-app-prev
    opts: *no_jit

  prev_ruby_yjit:
    build: *prev_ruby
    opts: *yjit

  truffleruby-dev:
    build: truffleruby-dev
    setarch: false
